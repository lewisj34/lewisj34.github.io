I"ô»<p>This will be a bit of a long read. But most likely worth it! This is a tutorial describing how to generate videos with masks overlaid from a trained CNN.</p>

<p>This tutorial assumes you have a trained model with a .pth file holding the trained weights. I trained my model using multiple GPUs so there is a segment of code 
in the following strip that has an option to put it into a <code class="language-plaintext highlighter-rouge">torch.nn.DataParallel()</code> object</p>

<p>Thereâ€™s a couple commandline options using the click interface. <br />
<code class="language-plaintext highlighter-rouge">results_dir</code>: where to save the results and where the config file detailing the 
model name is. <br />
<code class="language-plaintext highlighter-rouge">checkpoint_pth</code>: where the pth file is holding the trained model. <br />
<code class="language-plaintext highlighter-rouge">dataset</code>: the name of the dataset. <br />
<code class="language-plaintext highlighter-rouge">save_dir</code>: where the saved data corresponding to <code class="language-plaintext highlighter-rouge">dataset</code> is in .npy form 
is.<br /></p>

<p>This tutorial also assumes that the images you have are stills from a video that are <em>in order numerically</em>.</p>

<p>So you should have a file structure of images like:</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html">images/
â”œâ”€ 1.png
â”œâ”€ 2.png
â”œâ”€ 3.png
â”œâ”€ ...
gts/
â”œâ”€ 1.png
â”œâ”€ 2.png
â”œâ”€ 3.png
â”œâ”€ ...</code></pre></figure>

<p>Through the code an output dir containing the image will be generated as:</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html">outputs/
â”œâ”€ 1.png
â”œâ”€ 2.png
â”œâ”€ 3.png
â”œâ”€ ...</code></pre></figure>

<p>And here is the code!</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">os</span> 
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span> 
<span class="kn">import</span> <span class="nn">progressbar</span> 

<span class="kn">from</span> <span class="nn">model.FusionNetwork</span> <span class="kn">import</span> <span class="n">NewFusionNetwork</span>
<span class="kn">from</span> <span class="nn">data.dataset</span> <span class="kn">import</span> <span class="n">get_tDatasetImageTest</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span> 


<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">imageio</span> <span class="kn">import</span> <span class="n">imwrite</span>

<span class="k">def</span> <span class="nf">justGetBoundarySingleImage</span><span class="p">(</span>
    <span class="n">img_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="s">"""
    Takes a binary mask as input, @img_path, (just black + white) and returns 
    the boundary as a numpy array. Also saves it to the @output_path. 

    Taken from: https://medium.com/@rootaccess/how-to-detect-edges-of-a-mask-in-python-with-opencv-4bcdb3049682
    """</span>
    <span class="n">img_data</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
    <span class="n">img_data</span> <span class="o">=</span> <span class="n">img_data</span> <span class="o">&gt;</span> <span class="mi">128</span>

    <span class="n">img_data</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">gx</span><span class="p">,</span> <span class="n">gy</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">img_data</span><span class="p">)</span>
    <span class="n">temp_edge</span> <span class="o">=</span> <span class="n">gy</span> <span class="o">*</span> <span class="n">gy</span> <span class="o">+</span> <span class="n">gx</span> <span class="o">*</span> <span class="n">gx</span>
    <span class="n">temp_edge</span><span class="p">[</span><span class="n">temp_edge</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">255.0</span>
    <span class="n">temp_edge</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">temp_edge</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">uint8</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">output_path</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">cv2</span><span class="p">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">temp_edge</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">temp_edge</span>

<span class="k">def</span> <span class="nf">overlayOriginalImage</span><span class="p">(</span>
    <span class="n">img_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">msk_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">maskColor</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">'white'</span><span class="p">,</span> <span class="c1"># white, red, purple
</span>    <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">msk_edge</span> <span class="o">=</span> <span class="n">justGetBoundarySingleImage</span><span class="p">(</span><span class="n">msk_path</span><span class="p">)</span>

    <span class="n">og_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
    <span class="n">msk_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">msk_path</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">IMREAD_COLOR</span><span class="p">)</span>

    <span class="c1"># uncomment this line 
</span>    <span class="k">if</span> <span class="n">maskColor</span> <span class="o">==</span> <span class="s">'white'</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">maskColor</span> <span class="o">==</span> <span class="s">'red'</span><span class="p">:</span>
        <span class="n">msk_image</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">where</span><span class="p">((</span><span class="n">msk_image</span><span class="o">==</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">]).</span><span class="nb">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">))]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">maskColor</span> <span class="o">==</span> <span class="s">'green'</span><span class="p">:</span>
        <span class="n">msk_image</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">where</span><span class="p">((</span><span class="n">msk_image</span><span class="o">==</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">]).</span><span class="nb">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">))]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">maskColor</span> <span class="o">==</span> <span class="s">'lighter_pink'</span><span class="p">:</span>
        <span class="n">msk_image</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">where</span><span class="p">((</span><span class="n">msk_image</span><span class="o">==</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">]).</span><span class="nb">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">))]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">maskColor</span> <span class="o">==</span> <span class="s">'pink'</span><span class="p">:</span>
        <span class="n">msk_image</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">where</span><span class="p">((</span><span class="n">msk_image</span><span class="o">==</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">]).</span><span class="nb">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">))]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">maskColor</span> <span class="o">==</span> <span class="s">'grey'</span><span class="p">:</span>
        <span class="n">msk_image</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">where</span><span class="p">((</span><span class="n">msk_image</span><span class="o">==</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">]).</span><span class="nb">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">))]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span><span class="mi">165</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">'maskColor: </span><span class="si">{</span><span class="n">maskColor</span><span class="si">}</span><span class="s"> not available.'</span><span class="p">)</span>


    <span class="c1"># this puts on the annotation or prediction with some transparency
</span>    <span class="n">merged_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">addWeighted</span><span class="p">(</span><span class="n">og_image</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="n">msk_image</span><span class="p">,</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span>
    
    
    <span class="c1"># now put on the border with no transparency / full opacity 
</span>    <span class="n">merged_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">addWeighted</span><span class="p">(</span><span class="n">merged_image</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">msk_edge</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_GRAY2RGB</span><span class="p">),</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output_path</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">cv2</span><span class="p">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">merged_image</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">getSortedListOfFilePaths</span><span class="p">(</span><span class="nb">dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="s">"""
    returns list of files in @dir from os.listdir + the whole path to that file
    """</span>
    <span class="nb">list</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
    <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">]</span>
    <span class="nb">list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">])</span>
    <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dir</span> <span class="o">+</span> <span class="s">'/'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s">'.png'</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">list</span>

<span class="k">def</span> <span class="nf">getSortedListofFileNames</span><span class="p">(</span><span class="nb">dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="s">"""
    returns list of files from os.listdir just sorted (inc order) assuming ALL 
    numbers 
    same as above but just doesnt return the total path to the file it just 
    returns the file name 
    """</span>
    <span class="nb">list</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
    <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">]</span>
    <span class="nb">list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">])</span>
    <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s">'.png'</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">list</span>

<span class="k">def</span> <span class="nf">generate3Plot</span><span class="p">(</span>
    <span class="n">img_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">"1_img.png"</span><span class="p">,</span>
    <span class="n">imgann_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">"1_imgann.png"</span><span class="p">,</span>
    <span class="n">imgprd_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">"1_img_prd.png"</span><span class="p">,</span>
    <span class="n">save_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">'1.png'</span><span class="p">,</span>
<span class="p">):</span>
    <span class="s">"""
    taking the images, image+pred masks overlays, image+ann masks overlays, 
    generates a 3 plot of each and saves them each to a directory 
    """</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">IMREAD_COLOR</span><span class="p">);</span> <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
    <span class="n">ann</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">imgann_path</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">IMREAD_COLOR</span><span class="p">);</span> <span class="n">ann</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
    <span class="n">prd</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">imgprd_path</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">IMREAD_COLOR</span><span class="p">);</span> <span class="n">prd</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">prd</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>

    <span class="n">plt</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">use</span><span class="p">(</span><span class="s">'seaborn-white'</span><span class="p">)</span>

    <span class="c1"># note super titles (Original, Annotaiton, Predicted) DO NOT WORK (they cut off)
</span>    <span class="c1"># will have to add these manually if we want them though I think its easy
</span>    <span class="c1"># to work around this 
</span>    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axs</span><span class="p">.</span><span class="n">flatten</span><span class="p">()):</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="n">jet</span><span class="p">)</span>
            <span class="c1"># plt.title('Original')
</span>        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="n">jet</span><span class="p">)</span>
            <span class="c1"># plt.title('Annotation')
</span>        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">prd</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="n">jet</span><span class="p">)</span>
            <span class="c1"># plt.title('Predicted')
</span>        <span class="n">ax</span><span class="p">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
        <span class="n">ax</span><span class="p">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
        <span class="n">ax</span><span class="p">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s">'equal'</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>

    <span class="n">plt</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_name</span><span class="p">)</span>

<span class="o">@</span><span class="n">click</span><span class="p">.</span><span class="n">command</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
<span class="o">@</span><span class="n">click</span><span class="p">.</span><span class="n">option</span><span class="p">(</span><span class="s">'--results_dir'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">'results/DataParallel/DataParallel_11'</span><span class="p">)</span>
<span class="o">@</span><span class="n">click</span><span class="p">.</span><span class="n">option</span><span class="p">(</span><span class="s">'--checkpoint_pth'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">'results/DataParallel/DataParallel_11/current_checkpoints/DataParallel-218.pth'</span><span class="p">)</span>
<span class="o">@</span><span class="n">click</span><span class="p">.</span><span class="n">option</span><span class="p">(</span><span class="s">'--dataset'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">'CVC_ClinicDB'</span><span class="p">)</span>
<span class="o">@</span><span class="n">click</span><span class="p">.</span><span class="n">option</span><span class="p">(</span><span class="s">'--save_dir'</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">'seg/data/totals/CVC_ClinicDB/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span>
    <span class="n">model_name</span><span class="p">,</span>
    <span class="n">dataset</span><span class="p">,</span>
    <span class="n">results_dir</span><span class="p">,</span>
    <span class="n">checkpoint_pth</span><span class="p">,</span>
    <span class="n">save_dir</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">final_cfg</span> <span class="o">=</span> <span class="n">yaml</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">results_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s">"final_config.yml"</span><span class="p">,</span> <span class="s">"r"</span><span class="p">),</span>
        <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="p">.</span><span class="n">FullLoader</span><span class="p">)</span>
    
    <span class="n">model_name</span> <span class="o">=</span> <span class="n">final_cfg</span><span class="p">[</span><span class="s">'model_name'</span><span class="p">]</span>
    <span class="n">cnn_model_cfg</span> <span class="o">=</span> <span class="n">final_cfg</span><span class="p">[</span><span class="s">'cnn_model_cfg'</span><span class="p">]</span>
    <span class="n">trans_model_cfg</span> <span class="o">=</span> <span class="n">final_cfg</span><span class="p">[</span><span class="s">'trans_model_cfg'</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s">'NewFusionNetwork'</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">NewFusionNetwork</span><span class="p">(</span>
            <span class="n">cnn_model_cfg</span><span class="p">,</span>
            <span class="n">trans_model_cfg</span><span class="p">,</span>
            <span class="n">cnn_pretrained</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">with_fusion</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="p">).</span><span class="n">cuda</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">'invalid model: </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>

    <span class="n">num_gpu</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">device_count</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Number of GPUs: </span><span class="si">{</span><span class="n">num_gpu</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_gpu</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Device name: </span><span class="si">{</span><span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">get_device_name</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_gpu</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">DataParallel</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Resuming at path: </span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">basename</span><span class="p">(</span><span class="n">checkpoint_pth</span><span class="p">)</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
    <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint_pth</span><span class="p">)</span>
    <span class="n">model</span><span class="p">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s">'model_state_dict'</span><span class="p">])</span>

    <span class="c1"># model.load_state_dict(torch.load(checkpoint_pth))
</span>    <span class="n">model</span><span class="p">.</span><span class="n">cuda</span><span class="p">()</span>
    <span class="n">model</span><span class="p">.</span><span class="nb">eval</span><span class="p">()</span>

    <span class="n">save_path</span> <span class="o">=</span> <span class="n">results_dir</span> <span class="o">+</span> <span class="s">'/tests/'</span> <span class="o">+</span> <span class="n">dataset</span> <span class="o">+</span> <span class="s">'/'</span>
    <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_path</span> <span class="o">+</span> <span class="s">'/images/'</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_path</span> <span class="o">+</span> <span class="s">'/gts/'</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_path</span> <span class="o">+</span> <span class="s">'/outputs/'</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'os.save_path: </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>

    <span class="n">test_loader</span> <span class="o">=</span> <span class="n">get_tDatasetImageTest</span><span class="p">(</span>
        <span class="n">image_root</span> <span class="o">=</span> <span class="n">save_dir</span> <span class="o">+</span> <span class="s">"/data_dataset_list_ordered.npy"</span><span class="p">,</span>
        <span class="n">gt_root</span> <span class="o">=</span> <span class="n">save_dir</span> <span class="o">+</span> <span class="s">"/mask_dataset_list_ordered.npy"</span><span class="p">,</span>
        <span class="n">normalize_gt</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">normalization</span> <span class="o">=</span> <span class="s">"vit"</span><span class="p">,</span>
        <span class="n">num_workers</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> 
        <span class="n">pin_memory</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">originalTxtFile</span><span class="o">=</span> <span class="n">save_dir</span> <span class="o">+</span> <span class="s">"/dataset_list_ordered.txt"</span><span class="p">,</span> <span class="c1"># if it's not in the save_dir you have to move it there
</span>    <span class="p">)</span>
    <span class="k">with</span> <span class="n">progressbar</span><span class="p">.</span><span class="n">ProgressBar</span><span class="p">(</span><span class="n">max_value</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">test_loader</span><span class="p">))</span> <span class="k">as</span> <span class="n">bar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">image_gts</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_loader</span><span class="p">):</span>
            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">bar</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            
            <span class="n">images</span><span class="p">,</span> <span class="n">gts</span><span class="p">,</span> <span class="n">og_text</span> <span class="o">=</span> <span class="n">image_gts</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'og_text: </span><span class="si">{</span><span class="n">og_text</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="p">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="n">gts</span> <span class="o">=</span> <span class="n">gts</span><span class="p">.</span><span class="n">cuda</span><span class="p">()</span>

            <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>

            <span class="c1"># output = model(images)
</span>            <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="p">.</span><span class="n">sigmoid</span><span class="p">().</span><span class="n">data</span><span class="p">.</span><span class="n">cpu</span><span class="p">().</span><span class="n">numpy</span><span class="p">().</span><span class="n">squeeze</span><span class="p">()</span>
            
            <span class="n">name</span> <span class="o">=</span> <span class="n">dataset</span> <span class="o">+</span> <span class="s">'_'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">output_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s">'_output.jpg'</span>
            <span class="n">image_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s">'_image.jpg'</span>
            <span class="n">gt_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s">'_gt.jpg'</span>

            <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="p">.</span><span class="n">cpu</span><span class="p">().</span><span class="n">numpy</span><span class="p">().</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">gts</span> <span class="o">=</span> <span class="n">gts</span><span class="p">.</span><span class="n">cpu</span><span class="p">().</span><span class="n">numpy</span><span class="p">().</span><span class="n">squeeze</span><span class="p">().</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">imwrite</span><span class="p">(</span><span class="n">save_path</span> <span class="o">+</span> <span class="s">'/outputs/'</span> <span class="o">+</span> <span class="n">og_text</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">output</span><span class="p">)</span>
            <span class="n">imwrite</span><span class="p">(</span><span class="n">save_path</span> <span class="o">+</span> <span class="s">'/images/'</span> <span class="o">+</span> <span class="n">og_text</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">images</span><span class="p">)</span>
            <span class="n">imwrite</span><span class="p">(</span><span class="n">save_path</span> <span class="o">+</span> <span class="s">'/gts/'</span> <span class="o">+</span> <span class="n">og_text</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gts</span><span class="p">)</span>

    <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_dir</span> <span class="o">+</span> <span class="s">'/img_ann/'</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_dir</span> <span class="o">+</span> <span class="s">'/img_prd/'</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_dir</span> <span class="o">+</span> <span class="s">'/MultiPlot/'</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">img_names</span> <span class="o">=</span> <span class="n">getSortedListofFileNames</span><span class="p">(</span><span class="n">save_path</span> <span class="o">+</span> <span class="s">'/images/'</span><span class="p">)</span> <span class="c1"># all file names are the same {1, 2, ... x.png}
</span>    <span class="n">img_paths</span> <span class="o">=</span> <span class="n">getSortedListOfFilePaths</span><span class="p">(</span><span class="n">save_path</span> <span class="o">+</span> <span class="s">'/images/'</span><span class="p">)</span>
    <span class="n">ann_paths</span> <span class="o">=</span> <span class="n">getSortedListOfFilePaths</span><span class="p">(</span><span class="n">save_path</span> <span class="o">+</span> <span class="s">'/gts/'</span><span class="p">)</span>
    <span class="n">prd_paths</span> <span class="o">=</span> <span class="n">getSortedListOfFilePaths</span><span class="p">(</span><span class="n">save_path</span> <span class="o">+</span> <span class="s">'/outputs/'</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">progressbar</span><span class="p">.</span><span class="n">ProgressBar</span><span class="p">(</span><span class="n">max_value</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">img_names</span><span class="p">))</span> <span class="k">as</span> <span class="n">bar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">img_paths</span><span class="p">)):</span>
            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">bar</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="c1"># do it for the img + anns
</span>            <span class="n">overlayOriginalImage</span><span class="p">(</span>
                <span class="n">img_path</span><span class="o">=</span><span class="n">img_paths</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">msk_path</span><span class="o">=</span><span class="n">ann_paths</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">maskColor</span><span class="o">=</span><span class="s">'green'</span><span class="p">,</span>
                <span class="n">output_path</span><span class="o">=</span><span class="n">save_dir</span> <span class="o">+</span> <span class="s">'/img_ann/'</span> <span class="o">+</span> <span class="n">img_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="c1"># now for the img + prds
</span>            <span class="n">overlayOriginalImage</span><span class="p">(</span>
                <span class="n">img_path</span><span class="o">=</span><span class="n">img_paths</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">msk_path</span><span class="o">=</span><span class="n">prd_paths</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">maskColor</span><span class="o">=</span><span class="s">'pink'</span><span class="p">,</span>
                <span class="n">output_path</span><span class="o">=</span><span class="n">save_dir</span> <span class="o">+</span> <span class="s">'/img_prd/'</span> <span class="o">+</span> <span class="n">img_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="c1"># now that we have img_anns + img_preds images saved, now MultiPlot
</span>            <span class="n">generate3Plot</span><span class="p">(</span>
                <span class="n">img_path</span><span class="o">=</span><span class="n">img_paths</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">imgann_path</span><span class="o">=</span><span class="n">save_dir</span> <span class="o">+</span> <span class="s">'/img_ann/'</span> <span class="o">+</span> <span class="n">img_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">imgprd_path</span><span class="o">=</span><span class="n">save_dir</span> <span class="o">+</span> <span class="s">'/img_prd/'</span> <span class="o">+</span> <span class="n">img_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">save_name</span><span class="o">=</span><span class="n">save_dir</span> <span class="o">+</span> <span class="s">'/MultiPlot/'</span> <span class="o">+</span> <span class="n">img_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="p">)</span>

    


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span></code></pre></figure>

<p>You can then take the images from img_prd (which is the prediction overlayed the
original image) or the images from img_ann (which is the annotation overlayed the
original image) or the images from MultiPlot which are the original image along
with the img_prd and img_ann and plug them into a gif creator.</p>

<p>For the CVC-ClinicDB polyp dataset, putting the images from MultiPlot would look like this:<br />
<img src="/imgs/CVC_ColonDB_MultiPlot.gif" alt="" title="Input" /></p>

<p>I used imgflip.com.</p>

<p>Thanks for reading!</p>
:ET