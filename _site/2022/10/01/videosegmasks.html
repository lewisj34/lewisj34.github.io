<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="https://lewisj34.github.io//assets/css/syntax.css"><link rel="preconnect" href="https://cdnjs.cloudflare.com"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><title> Generating Video with Segmentation Masks - JCL</title><link rel="shortcut icon" href="https://lewisj34.github.io//favicon.png"><link rel="alternate" type="application/atom+xml" title="JCL" href="https://lewisj34.github.io//atom.xml"><link rel="alternate" type="application/json" title="JCL" href="https://lewisj34.github.io//feed.json" /><link rel="sitemap" type="application/xml" title="sitemap" href="https://lewisj34.github.io//sitemap.xml" /><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&family=Source+Code+Pro:ital,wght@0,200;0,300;0,400;0,600;0,700;0,900;1,300;1,400;1,500;1,600;1,700;1,900&display=swap" rel="stylesheet"><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}html{font-size:15px}#theme-toggle{opacity:0.65;position:relative;border-radius:5px;height:25px;display:flex;-webkit-box-align:center;align-items:center;-webkit-box-pack:center;justify-content:center;transition:opacity 0.3s ease 0s;border:none;outline:none;background:none;cursor:pointer;padding:0px;appearance:none;transform:scale(0.8)}html,html[data-theme="light"]{--text-font: Play;--source-code-font: Source Code Pro;--very-light-text-color: rgb(222, 222, 222);--light-text-color: rgb(89, 183, 255);--medium-text-color: #555;--main-text-color: #333;--highlight-text-color: #6cb4a0;--dark-text-color: #393e46;--link-color: rgb(50, 87, 209);--code-bg-color: rgb(245, 245, 245);background-color:#fff}html #theme-toggle div,html[data-theme="light"] #theme-toggle div{position:relative;width:24px;height:24px;border-radius:50%;border:none;background-color:var(--theme-ui-colors-transparent, transparent);transform:scale(1);transition:all 0.45s ease 0s;overflow:hidden;box-shadow:inset 8px -8px 0px 0px var(--theme-ui-colors-toggleIcon, #2d3748)}html #theme-toggle div::before,html[data-theme="light"] #theme-toggle div::before{content:"";position:absolute;right:-9px;top:-9px;height:24px;width:24px;border:none;border-radius:50%;transform:translate(0px, 0px);opacity:1;transition:transform 0.45s ease 0s}html #theme-toggle div::after,html[data-theme="light"] #theme-toggle div::after{content:"";width:8px;height:8px;border-radius:50%;margin:-4px 0px 0px -4px;position:absolute;top:50%;left:50%;box-shadow:0 -23px 0 var(--theme-ui-colors-toggleIcon, #2d3748),0 23px 0 var(--theme-ui-colors-toggleIcon, #2d3748),23px 0 0 var(--theme-ui-colors-toggleIcon, #2d3748),-23px 0 0 var(--theme-ui-colors-toggleIcon, #2d3748),15px 15px 0 var(--theme-ui-colors-toggleIcon, #2d3748),-15px 15px 0 var(--theme-ui-colors-toggleIcon, #2d3748),15px -15px 0 var(--theme-ui-colors-toggleIcon, #2d3748),-15px -15px 0 var(--theme-ui-colors-toggleIcon, #2d3748);transform:scale(0);transition:all 0.35s ease 0s}html[data-theme="dark"]{--text-font: Play;--source-code-font: Source Code Pro;--very-light-text-color: #EEE;--light-text-color: #c4bbf0;--medium-text-color: #52057b;--main-text-color: #EAEAEA;--highlight-text-color: #6cb4a0;--dark-text-color: rgb(36, 38, 42);--link-color: rgb(255, 89, 125);--code-bg-color: rgb(36, 38, 42);background-color:#131418}html[data-theme="dark"] #theme-toggle div{position:relative;width:24px;height:24px;border-radius:50%;border:4px solid var(--theme-ui-colors-toggleIcon, #cbd5e0);background-color:var(--theme-ui-colors-toggleIcon, #cbd5e0);transform:scale(0.55);transition:all 0.45s ease 0s;overflow:visible;box-shadow:none}html[data-theme="dark"] #theme-toggle div::before{content:"";position:absolute;right:-9px;top:-9px;height:24px;width:24px;border:2px solid var(--theme-ui-colors-toggleIcon, #cbd5e0);border-radius:50%;transform:translate(14px, -14px);opacity:0;transition:transform 0.45s ease 0s}html[data-theme="dark"] #theme-toggle div::after{content:"";width:8px;height:8px;border-radius:50%;margin:-4px 0px 0px -4px;position:absolute;top:50%;left:50%;box-shadow:0 -23px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0),0 23px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0),23px 0 0 var(--theme-ui-colors-toggleIcon, #cbd5e0),-23px 0 0 var(--theme-ui-colors-toggleIcon, #cbd5e0),15px 15px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0),-15px 15px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0),15px -15px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0),-15px -15px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0);transform:scale(1);transition:all 0.35s ease 0s}body{font-family:var(--text-font),monospace;text-rendering:optimizeLegibility;line-height:1.75;color:var(--main-text-color)}a{color:var(--link-color);text-decoration:none}.post p{margin:1rem 0}.meta{margin:1.4rem 0}code,pre{background:var(--code-bg-color);margin:0 -27px;border-width:1px}code{font-family:var(--source-code-font),monospace;margin:unset;padding:0.1rem;color:var(--highlight-text-color)}pre code{background-color:unset;color:unset}pre{border-width:3px;padding:0.8rem;white-space:pre-wrap;border-style:none none none solid;border-color:var(--light-text-color)}img{max-width:100%}hr{background:var(--light-text-color);height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:0.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem 0}section{margin-top:5.5rem}blockquote{font-style:italic;border-left:5px solid var(--dark-text-color);padding-left:1rem}h1{color:var(--main-text-color);text-transform:uppercase;font-size:2rem;font-weight:bold;margin-bottom:1.5rem}h2,h3,h4,h5{font-weight:bold;margin-bottom:1.5rem;font-size:2rem}h2{font-size:1.8rem}h3{font-size:1.6rem}h4{font-size:1.4rem}h5{font-size:1.2rem}h6{font-size:1rem}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:0.5rem}.posts>h3{font-weight:500}.post ul{margin:0px;margin:0px 0px 10px 10px}.post ol{margin:0px;margin:0px 0px 10px 15px}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:0.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:bold}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}time{color:var(--main-text-color)}.post>h1.title{font-size:x-large;margin-top:0;margin-bottom:0}.post>time{margin-bottom:0;margin-top:3rem}.highlight{margin:0px}main{display:flex;max-width:47rem;margin:-5rem auto 0;padding:2.4rem 2rem;flex-direction:column}.flex-row-between{display:flex;flex-direction:row;justify-content:space-between}.social-footer{padding:1rem;display:flex;justify-content:center;position:initial}.social-footer .social-footer-icons .fa{font-size:1.3rem;color:#a9a9a9}.social-footer .social-footer-icons .fa:hover{color:dimgray;transition:color 0.3s ease-in}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:0.5rem}main{padding:0 2rem}}section{flex-grow:999;display:flex;flex-direction:column}figcaption{font-size:smaller}.bio{margin-bottom:5rem}::selection{background-color:#fffba0;color:#333}.search-article{position:relative}.search-article label[for="search-input"]{position:relative;top:-10px;left:11px}.search-article input[type="search"]{top:-1rem;left:0;border:0;width:100%;height:30px;outline:none;position:absolute;border-radius:5px;padding:10px 10px 10px 35px;color:var(--main-text-color);-webkit-appearance:none;background-color:rgba(128,128,128,0.1);border:1px solid rgba(128,128,128,0.1)}.search-article input[type="search"]::-webkit-input-placeholder{color:#808080}.search-article input[type="search"]::-webkit-search-decoration,.search-article input[type="search"]::-webkit-search-results-decoration{display:none}#search-results{text-align:center}#search-results li{text-align:center}#search-results li::before{content:"›";display:inline-block;margin-left:-1.3em;width:1.3em;color:var(--main-text-color)}.post-nav{display:flex;position:relative;margin-top:0;border-top:2px solid var(--light-text-color);line-height:1.4}.post-nav .post-nav-item{border-bottom:0;padding-bottom:10px;width:50%;padding-top:10px;text-decoration:none;box-sizing:border-box}.post-nav .post-nav-item .post-title{color:var(--main-text-color)}.post-nav .post-nav-item:hover .post-title,.post-nav .post-nav-item:focus .post-title{color:var(--link-color);opacity:0.9}.post-nav .post-nav-item .nav-arrow{font-size:17px;color:var(--main-text-color);margin-bottom:3px;font-weight:bold}.post-nav .post-nav-item:nth-child(odd){padding-left:0;padding-right:20px}.post-nav .post-nav-item:nth-child(even){text-align:right;padding-right:0;padding-left:20px}.tags ul{list-style:none;display:grid;grid-template-columns:auto auto auto auto auto auto;grid-template-rows:auto auto auto auto}.tags li{white-space:normal;text-overflow:ellipsis}.timeline{position:center;width:650px;margin:-6em auto;padding:1px;list-style-type:none}@media (max-width: 860px){.timeline{width:100%}}.timeline:before{position:absolute;left:50%;top:0;content:' ';display:block;width:6px;height:100%;margin-left:-3px;background:var(--light-text-color);z-index:5}@media (max-width: 375px){.timeline:before{height:150%}}.timeline li{padding:2em 0}@media (max-width: 860px){.timeline li{padding:2em 0}}.timeline li::after{content:"";display:block;height:150%;clear:both;visibility:hidden}.direction-l{position:relative;width:287px;float:left;text-align:right}@media (max-width: 860px){.direction-l{float:none;width:100%;text-align:center}}.direction-l .flag{color:#333;box-shadow:-1px 1px 1px rgba(0,0,0,0.52)}.direction-l .flag:after{content:"";position:absolute;left:100%;top:50%;height:0;width:0;margin-top:-8px;border:solid transparent;border-left-color:#f8f8f8;border-width:8px;pointer-events:none}@media (max-width: 860px){.direction-l .flag:after{content:"";position:absolute;left:50%;top:-8px;height:0;width:0;margin-left:-8px;border:solid transparent;border-bottom-color:#fff;border-width:8px;pointer-events:none}}.direction-l .time-wrapper{float:left}@media (max-width: 860px){.direction-l .time-wrapper{float:none}}.direction-r{position:relative;width:293px;float:right;text-align:left}@media (max-width: 860px){.direction-r{float:none;width:100%;text-align:center}}.direction-r .flag{color:#333;box-shadow:1px 1px 1px rgba(0,0,0,0.52)}.direction-r .flag:after{content:"";position:absolute;right:100%;top:50%;height:0;width:0;margin-top:-8px;border:solid transparent;border-right-color:#f8f8f8;border-width:8px;pointer-events:none}@media (max-width: 860px){.direction-r .flag:after{content:"";position:absolute;left:50%;top:-8px;height:0;width:0;margin-left:-8px;border:solid transparent;border-bottom-color:#fff;border-width:8px;pointer-events:none}}.direction-r .flag:before{left:-40px}.direction-r .time-wrapper{float:right}@media (max-width: 860px){.direction-r .time-wrapper{float:none}}.flag-wrapper{position:relative;display:inline-block;text-align:center}@media (max-width: 860px){.flag-wrapper{text-align:center}}.flag-wrapper .flag{position:relative;display:inline;background:#f8f8f8;padding:6px 10px;border-radius:5px;font-weight:600;text-align:left}@media (max-width: 860px){.flag-wrapper .flag{background:#fff;z-index:15}}.direction-l .flag:before,.direction-r .flag:before{position:absolute;top:60%;right:-40px;content:' ';display:block;width:12px;height:12px;margin-top:-10px;background:#fff;border-radius:10px;border:4px solid var(--link-color);z-index:10}@media (max-width: 860px){.direction-l .flag:before,.direction-r .flag:before{position:absolute;top:-30px;left:53%;content:' ';display:block;margin-left:-10px}}.time-wrapper{display:inline;line-height:1em;font-size:0.66666em;color:var(--link-color);vertical-align:middle}@media (max-width: 860px){.time-wrapper{display:block;position:relative;margin:4px 0 0 0;z-index:14}}.time-wrapper .time{display:inline-block;padding:4px 6px;background:#f8f8f8}.desc{margin:1em 0.2em -3.5em 0;font-size:0.9em;line-height:1.5em}.desc a{color:var(--link-color);text-decoration:none}.desc a:hover{text-decoration:underline}@media (max-width: 860px){.desc{position:relative;margin:1em 1em 0 1em;padding:1em;background:var(--code-bg-color);box-shadow:0 0 1px rgba(0,0,0,0.2);z-index:15}}</style></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-3EP7KLCYVP"></script> <script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-3EP7KLCYVP'); </script><body><main><section class="post"><div class="flex-row-between"> <a href="https://lewisj34.github.io//">« back</a> <button title="Change theme" id="theme-toggle" onclick="modeSwitcher()"><div></div></button></div><time datetime="2022-10-01T21:30:52+02:00">Oct 1, 2022 - 11 ' read</time><h1 class="title"> Generating Video with Segmentation Masks</h1><span class="meta"> </span><p>This will be a bit of a long read. But most likely worth it! This is a tutorial describing how to generate videos with masks overlaid from a trained CNN.</p><p>This tutorial assumes you have a trained model with a .pth file holding the trained weights. I trained my model using multiple GPUs so there is a segment of code in the following strip that has an option to put it into a <code class="language-plaintext highlighter-rouge">torch.nn.DataParallel()</code> object</p><p>There’s a couple commandline options using the click interface. <br /> <code class="language-plaintext highlighter-rouge">results_dir</code>: where to save the results and where the config file detailing the model name is. <br /> <code class="language-plaintext highlighter-rouge">checkpoint_pth</code>: where the pth file is holding the trained model. <br /> <code class="language-plaintext highlighter-rouge">dataset</code>: the name of the dataset. <br /> <code class="language-plaintext highlighter-rouge">save_dir</code>: where the saved data corresponding to <code class="language-plaintext highlighter-rouge">dataset</code> is in .npy form is.<br /></p><p>This tutorial also assumes that the images you have are stills from a video that are <em>in order numerically</em>.</p><p>So you should have a file structure of images like:</p><figure class="highlight"><pre><code class="language-html" data-lang="html">images/
├─ 1.png
├─ 2.png
├─ 3.png
├─ ...
gts/
├─ 1.png
├─ 2.png
├─ 3.png
├─ ...</code></pre></figure><p>Through the code an output dir containing the image will be generated as:</p><figure class="highlight"><pre><code class="language-html" data-lang="html">outputs/
├─ 1.png
├─ 2.png
├─ 3.png
├─ ...</code></pre></figure><p>And here is the code!</p><figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">os</span> 
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span> 
<span class="kn">import</span> <span class="nn">progressbar</span> 

<span class="kn">from</span> <span class="nn">model.FusionNetwork</span> <span class="kn">import</span> <span class="n">NewFusionNetwork</span>
<span class="kn">from</span> <span class="nn">data.dataset</span> <span class="kn">import</span> <span class="n">get_tDatasetImageTest</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span> 


<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">imageio</span> <span class="kn">import</span> <span class="n">imwrite</span>

<span class="k">def</span> <span class="nf">justGetBoundarySingleImage</span><span class="p">(</span>
    <span class="n">img_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="s">"""
    Takes a binary mask as input, @img_path, (just black + white) and returns 
    the boundary as a numpy array. Also saves it to the @output_path. 

    Taken from: https://medium.com/@rootaccess/how-to-detect-edges-of-a-mask-in-python-with-opencv-4bcdb3049682
    """</span>
    <span class="n">img_data</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
    <span class="n">img_data</span> <span class="o">=</span> <span class="n">img_data</span> <span class="o">&gt;</span> <span class="mi">128</span>

    <span class="n">img_data</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">gx</span><span class="p">,</span> <span class="n">gy</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">img_data</span><span class="p">)</span>
    <span class="n">temp_edge</span> <span class="o">=</span> <span class="n">gy</span> <span class="o">*</span> <span class="n">gy</span> <span class="o">+</span> <span class="n">gx</span> <span class="o">*</span> <span class="n">gx</span>
    <span class="n">temp_edge</span><span class="p">[</span><span class="n">temp_edge</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">255.0</span>
    <span class="n">temp_edge</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">temp_edge</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">uint8</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">output_path</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">cv2</span><span class="p">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">temp_edge</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">temp_edge</span>

<span class="k">def</span> <span class="nf">overlayOriginalImage</span><span class="p">(</span>
    <span class="n">img_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">msk_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">maskColor</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">'white'</span><span class="p">,</span> <span class="c1"># white, red, purple
</span>    <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">msk_edge</span> <span class="o">=</span> <span class="n">justGetBoundarySingleImage</span><span class="p">(</span><span class="n">msk_path</span><span class="p">)</span>

    <span class="n">og_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
    <span class="n">msk_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">msk_path</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">IMREAD_COLOR</span><span class="p">)</span>

    <span class="c1"># uncomment this line 
</span>    <span class="k">if</span> <span class="n">maskColor</span> <span class="o">==</span> <span class="s">'white'</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">maskColor</span> <span class="o">==</span> <span class="s">'red'</span><span class="p">:</span>
        <span class="n">msk_image</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">where</span><span class="p">((</span><span class="n">msk_image</span><span class="o">==</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">]).</span><span class="nb">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">))]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">maskColor</span> <span class="o">==</span> <span class="s">'green'</span><span class="p">:</span>
        <span class="n">msk_image</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">where</span><span class="p">((</span><span class="n">msk_image</span><span class="o">==</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">]).</span><span class="nb">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">))]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">maskColor</span> <span class="o">==</span> <span class="s">'lighter_pink'</span><span class="p">:</span>
        <span class="n">msk_image</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">where</span><span class="p">((</span><span class="n">msk_image</span><span class="o">==</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">]).</span><span class="nb">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">))]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">maskColor</span> <span class="o">==</span> <span class="s">'pink'</span><span class="p">:</span>
        <span class="n">msk_image</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">where</span><span class="p">((</span><span class="n">msk_image</span><span class="o">==</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">]).</span><span class="nb">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">))]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">maskColor</span> <span class="o">==</span> <span class="s">'grey'</span><span class="p">:</span>
        <span class="n">msk_image</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">where</span><span class="p">((</span><span class="n">msk_image</span><span class="o">==</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">]).</span><span class="nb">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">))]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span><span class="mi">165</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">'maskColor: </span><span class="si">{</span><span class="n">maskColor</span><span class="si">}</span><span class="s"> not available.'</span><span class="p">)</span>


    <span class="c1"># this puts on the annotation or prediction with some transparency
</span>    <span class="n">merged_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">addWeighted</span><span class="p">(</span><span class="n">og_image</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="n">msk_image</span><span class="p">,</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span>
    
    
    <span class="c1"># now put on the border with no transparency / full opacity 
</span>    <span class="n">merged_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">addWeighted</span><span class="p">(</span><span class="n">merged_image</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">msk_edge</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_GRAY2RGB</span><span class="p">),</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output_path</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">cv2</span><span class="p">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">merged_image</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">getSortedListOfFilePaths</span><span class="p">(</span><span class="nb">dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="s">"""
    returns list of files in @dir from os.listdir + the whole path to that file
    """</span>
    <span class="nb">list</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
    <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">]</span>
    <span class="nb">list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">])</span>
    <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dir</span> <span class="o">+</span> <span class="s">'/'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s">'.png'</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">list</span>

<span class="k">def</span> <span class="nf">getSortedListofFileNames</span><span class="p">(</span><span class="nb">dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="s">"""
    returns list of files from os.listdir just sorted (inc order) assuming ALL 
    numbers 
    same as above but just doesnt return the total path to the file it just 
    returns the file name 
    """</span>
    <span class="nb">list</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
    <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">]</span>
    <span class="nb">list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">])</span>
    <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s">'.png'</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">list</span>

<span class="k">def</span> <span class="nf">generate3Plot</span><span class="p">(</span>
    <span class="n">img_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">"1_img.png"</span><span class="p">,</span>
    <span class="n">imgann_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">"1_imgann.png"</span><span class="p">,</span>
    <span class="n">imgprd_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">"1_img_prd.png"</span><span class="p">,</span>
    <span class="n">save_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">'1.png'</span><span class="p">,</span>
<span class="p">):</span>
    <span class="s">"""
    taking the images, image+pred masks overlays, image+ann masks overlays, 
    generates a 3 plot of each and saves them each to a directory 
    """</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">IMREAD_COLOR</span><span class="p">);</span> <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
    <span class="n">ann</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">imgann_path</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">IMREAD_COLOR</span><span class="p">);</span> <span class="n">ann</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
    <span class="n">prd</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">imgprd_path</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">IMREAD_COLOR</span><span class="p">);</span> <span class="n">prd</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">prd</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>

    <span class="n">plt</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">use</span><span class="p">(</span><span class="s">'seaborn-white'</span><span class="p">)</span>

    <span class="c1"># note super titles (Original, Annotaiton, Predicted) DO NOT WORK (they cut off)
</span>    <span class="c1"># will have to add these manually if we want them though I think its easy
</span>    <span class="c1"># to work around this 
</span>    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axs</span><span class="p">.</span><span class="n">flatten</span><span class="p">()):</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="n">jet</span><span class="p">)</span>
            <span class="c1"># plt.title('Original')
</span>        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="n">jet</span><span class="p">)</span>
            <span class="c1"># plt.title('Annotation')
</span>        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">prd</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="n">jet</span><span class="p">)</span>
            <span class="c1"># plt.title('Predicted')
</span>        <span class="n">ax</span><span class="p">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
        <span class="n">ax</span><span class="p">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
        <span class="n">ax</span><span class="p">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s">'equal'</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>

    <span class="n">plt</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_name</span><span class="p">)</span>

<span class="o">@</span><span class="n">click</span><span class="p">.</span><span class="n">command</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
<span class="o">@</span><span class="n">click</span><span class="p">.</span><span class="n">option</span><span class="p">(</span><span class="s">'--results_dir'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">'results/DataParallel/DataParallel_11'</span><span class="p">)</span>
<span class="o">@</span><span class="n">click</span><span class="p">.</span><span class="n">option</span><span class="p">(</span><span class="s">'--checkpoint_pth'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">'results/DataParallel/DataParallel_11/current_checkpoints/DataParallel-218.pth'</span><span class="p">)</span>
<span class="o">@</span><span class="n">click</span><span class="p">.</span><span class="n">option</span><span class="p">(</span><span class="s">'--dataset'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">'CVC_ClinicDB'</span><span class="p">)</span>
<span class="o">@</span><span class="n">click</span><span class="p">.</span><span class="n">option</span><span class="p">(</span><span class="s">'--save_dir'</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">'seg/data/totals/CVC_ClinicDB/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span>
    <span class="n">model_name</span><span class="p">,</span>
    <span class="n">dataset</span><span class="p">,</span>
    <span class="n">results_dir</span><span class="p">,</span>
    <span class="n">checkpoint_pth</span><span class="p">,</span>
    <span class="n">save_dir</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">final_cfg</span> <span class="o">=</span> <span class="n">yaml</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">results_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s">"final_config.yml"</span><span class="p">,</span> <span class="s">"r"</span><span class="p">),</span>
        <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="p">.</span><span class="n">FullLoader</span><span class="p">)</span>
    
    <span class="n">model_name</span> <span class="o">=</span> <span class="n">final_cfg</span><span class="p">[</span><span class="s">'model_name'</span><span class="p">]</span>
    <span class="n">cnn_model_cfg</span> <span class="o">=</span> <span class="n">final_cfg</span><span class="p">[</span><span class="s">'cnn_model_cfg'</span><span class="p">]</span>
    <span class="n">trans_model_cfg</span> <span class="o">=</span> <span class="n">final_cfg</span><span class="p">[</span><span class="s">'trans_model_cfg'</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s">'NewFusionNetwork'</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">NewFusionNetwork</span><span class="p">(</span>
            <span class="n">cnn_model_cfg</span><span class="p">,</span>
            <span class="n">trans_model_cfg</span><span class="p">,</span>
            <span class="n">cnn_pretrained</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">with_fusion</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="p">).</span><span class="n">cuda</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">'invalid model: </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>

    <span class="n">num_gpu</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">device_count</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Number of GPUs: </span><span class="si">{</span><span class="n">num_gpu</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_gpu</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Device name: </span><span class="si">{</span><span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">get_device_name</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_gpu</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">DataParallel</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Resuming at path: </span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">basename</span><span class="p">(</span><span class="n">checkpoint_pth</span><span class="p">)</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
    <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint_pth</span><span class="p">)</span>
    <span class="n">model</span><span class="p">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s">'model_state_dict'</span><span class="p">])</span>

    <span class="c1"># model.load_state_dict(torch.load(checkpoint_pth))
</span>    <span class="n">model</span><span class="p">.</span><span class="n">cuda</span><span class="p">()</span>
    <span class="n">model</span><span class="p">.</span><span class="nb">eval</span><span class="p">()</span>

    <span class="n">save_path</span> <span class="o">=</span> <span class="n">results_dir</span> <span class="o">+</span> <span class="s">'/tests/'</span> <span class="o">+</span> <span class="n">dataset</span> <span class="o">+</span> <span class="s">'/'</span>
    <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_path</span> <span class="o">+</span> <span class="s">'/images/'</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_path</span> <span class="o">+</span> <span class="s">'/gts/'</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_path</span> <span class="o">+</span> <span class="s">'/outputs/'</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'os.save_path: </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>

    <span class="n">test_loader</span> <span class="o">=</span> <span class="n">get_tDatasetImageTest</span><span class="p">(</span>
        <span class="n">image_root</span> <span class="o">=</span> <span class="n">save_dir</span> <span class="o">+</span> <span class="s">"/data_dataset_list_ordered.npy"</span><span class="p">,</span>
        <span class="n">gt_root</span> <span class="o">=</span> <span class="n">save_dir</span> <span class="o">+</span> <span class="s">"/mask_dataset_list_ordered.npy"</span><span class="p">,</span>
        <span class="n">normalize_gt</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">normalization</span> <span class="o">=</span> <span class="s">"vit"</span><span class="p">,</span>
        <span class="n">num_workers</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> 
        <span class="n">pin_memory</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">originalTxtFile</span><span class="o">=</span> <span class="n">save_dir</span> <span class="o">+</span> <span class="s">"/dataset_list_ordered.txt"</span><span class="p">,</span> <span class="c1"># if it's not in the save_dir you have to move it there
</span>    <span class="p">)</span>
    <span class="k">with</span> <span class="n">progressbar</span><span class="p">.</span><span class="n">ProgressBar</span><span class="p">(</span><span class="n">max_value</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">test_loader</span><span class="p">))</span> <span class="k">as</span> <span class="n">bar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">image_gts</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_loader</span><span class="p">):</span>
            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">bar</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            
            <span class="n">images</span><span class="p">,</span> <span class="n">gts</span><span class="p">,</span> <span class="n">og_text</span> <span class="o">=</span> <span class="n">image_gts</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'og_text: </span><span class="si">{</span><span class="n">og_text</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="p">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="n">gts</span> <span class="o">=</span> <span class="n">gts</span><span class="p">.</span><span class="n">cuda</span><span class="p">()</span>

            <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>

            <span class="c1"># output = model(images)
</span>            <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="p">.</span><span class="n">sigmoid</span><span class="p">().</span><span class="n">data</span><span class="p">.</span><span class="n">cpu</span><span class="p">().</span><span class="n">numpy</span><span class="p">().</span><span class="n">squeeze</span><span class="p">()</span>
            
            <span class="n">name</span> <span class="o">=</span> <span class="n">dataset</span> <span class="o">+</span> <span class="s">'_'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">output_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s">'_output.jpg'</span>
            <span class="n">image_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s">'_image.jpg'</span>
            <span class="n">gt_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s">'_gt.jpg'</span>

            <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="p">.</span><span class="n">cpu</span><span class="p">().</span><span class="n">numpy</span><span class="p">().</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">gts</span> <span class="o">=</span> <span class="n">gts</span><span class="p">.</span><span class="n">cpu</span><span class="p">().</span><span class="n">numpy</span><span class="p">().</span><span class="n">squeeze</span><span class="p">().</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">imwrite</span><span class="p">(</span><span class="n">save_path</span> <span class="o">+</span> <span class="s">'/outputs/'</span> <span class="o">+</span> <span class="n">og_text</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">output</span><span class="p">)</span>
            <span class="n">imwrite</span><span class="p">(</span><span class="n">save_path</span> <span class="o">+</span> <span class="s">'/images/'</span> <span class="o">+</span> <span class="n">og_text</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">images</span><span class="p">)</span>
            <span class="n">imwrite</span><span class="p">(</span><span class="n">save_path</span> <span class="o">+</span> <span class="s">'/gts/'</span> <span class="o">+</span> <span class="n">og_text</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gts</span><span class="p">)</span>

    <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_dir</span> <span class="o">+</span> <span class="s">'/img_ann/'</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_dir</span> <span class="o">+</span> <span class="s">'/img_prd/'</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_dir</span> <span class="o">+</span> <span class="s">'/MultiPlot/'</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">img_names</span> <span class="o">=</span> <span class="n">getSortedListofFileNames</span><span class="p">(</span><span class="n">save_path</span> <span class="o">+</span> <span class="s">'/images/'</span><span class="p">)</span> <span class="c1"># all file names are the same {1, 2, ... x.png}
</span>    <span class="n">img_paths</span> <span class="o">=</span> <span class="n">getSortedListOfFilePaths</span><span class="p">(</span><span class="n">save_path</span> <span class="o">+</span> <span class="s">'/images/'</span><span class="p">)</span>
    <span class="n">ann_paths</span> <span class="o">=</span> <span class="n">getSortedListOfFilePaths</span><span class="p">(</span><span class="n">save_path</span> <span class="o">+</span> <span class="s">'/gts/'</span><span class="p">)</span>
    <span class="n">prd_paths</span> <span class="o">=</span> <span class="n">getSortedListOfFilePaths</span><span class="p">(</span><span class="n">save_path</span> <span class="o">+</span> <span class="s">'/outputs/'</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">progressbar</span><span class="p">.</span><span class="n">ProgressBar</span><span class="p">(</span><span class="n">max_value</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">img_names</span><span class="p">))</span> <span class="k">as</span> <span class="n">bar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">img_paths</span><span class="p">)):</span>
            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">bar</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="c1"># do it for the img + anns
</span>            <span class="n">overlayOriginalImage</span><span class="p">(</span>
                <span class="n">img_path</span><span class="o">=</span><span class="n">img_paths</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">msk_path</span><span class="o">=</span><span class="n">ann_paths</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">maskColor</span><span class="o">=</span><span class="s">'green'</span><span class="p">,</span>
                <span class="n">output_path</span><span class="o">=</span><span class="n">save_dir</span> <span class="o">+</span> <span class="s">'/img_ann/'</span> <span class="o">+</span> <span class="n">img_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="c1"># now for the img + prds
</span>            <span class="n">overlayOriginalImage</span><span class="p">(</span>
                <span class="n">img_path</span><span class="o">=</span><span class="n">img_paths</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">msk_path</span><span class="o">=</span><span class="n">prd_paths</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">maskColor</span><span class="o">=</span><span class="s">'pink'</span><span class="p">,</span>
                <span class="n">output_path</span><span class="o">=</span><span class="n">save_dir</span> <span class="o">+</span> <span class="s">'/img_prd/'</span> <span class="o">+</span> <span class="n">img_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="c1"># now that we have img_anns + img_preds images saved, now MultiPlot
</span>            <span class="n">generate3Plot</span><span class="p">(</span>
                <span class="n">img_path</span><span class="o">=</span><span class="n">img_paths</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">imgann_path</span><span class="o">=</span><span class="n">save_dir</span> <span class="o">+</span> <span class="s">'/img_ann/'</span> <span class="o">+</span> <span class="n">img_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">imgprd_path</span><span class="o">=</span><span class="n">save_dir</span> <span class="o">+</span> <span class="s">'/img_prd/'</span> <span class="o">+</span> <span class="n">img_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">save_name</span><span class="o">=</span><span class="n">save_dir</span> <span class="o">+</span> <span class="s">'/MultiPlot/'</span> <span class="o">+</span> <span class="n">img_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="p">)</span>

    


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span></code></pre></figure><p>You can then take the images from img_prd (which is the prediction overlayed the original image) or the images from img_ann (which is the annotation overlayed the original image) or the images from MultiPlot which are the original image along with the img_prd and img_ann and plug them into a gif creator.</p><p>For the CVC-ClinicDB polyp dataset, putting the images from MultiPlot would look like this:<br /> <img src="/imgs/CVC_ColonDB_MultiPlot.gif" alt="" title="Input" /></p><p>I used imgflip.com.</p><p>Thanks for reading!</p></section><section><nav class="post-nav"> <a class="post-nav-item post-nav-prev" href="/2021/01/02/convcudnn"><div class="nav-arrow">Previous</div><span class="post-title">Convolutions with cuDNN</span> </a></nav></section><div id="disqus_thread" class="article-comments"></div><script> (function() { var d = document, s = d.createElement('script'); s.src = '//powex.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></main><script> function setTheme(theme) { if (theme === "dark") { document.documentElement.setAttribute('data-theme', 'dark'); window.localStorage.setItem('theme', 'dark'); document.getElementById("theme-toggle").classList.add('sun'); document.getElementById("theme-toggle").classList.remove('moon'); } else { document.documentElement.setAttribute('data-theme', 'light'); window.localStorage.setItem('theme', 'light'); document.getElementById("theme-toggle").classList.add('moon'); document.getElementById("theme-toggle").classList.remove('sun'); } } let theme = localStorage.getItem('theme'); theme = theme || (window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light' : 'light'); setTheme(theme); function modeSwitcher() { let currentMode = document.documentElement.getAttribute('data-theme'); if (currentMode === "dark") { setTheme('light'); } else { setTheme('dark'); } } </script></body><footer class="social-footer"><div class="social-footer-icons"> <a href="https://github.com/lewisj34" title="Github profile" target="_blank" rel="noopener noreferrer"><i class="fa fa-github" aria-hidden="true"></i></a> <a href="https://lewisj34.github.io//atom.xml" title="Feed RSS" target="_blank" rel="noopener noreferrer"><i class="fa fa-rss" aria-hidden="true"></i></a> <a href="https://www.youtube.com/channel/UCWAGdsDYBYcwvw-7PPdSZrw" title="Youtube" target="_blank" rel="noopener noreferrer"><i class="fa fa-youtube-play" aria-hidden="true"></i></a></div></footer></html>
